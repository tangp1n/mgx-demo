# 代码生成诊断指南

## 问题描述

当代码生成已经开始（从日志可以看到），但前端点击 Code tab 时显示没有内容。

## 可能的原因

1. **代码生成还在进行中** - 容器已创建，但文件还没有生成完成
2. **容器创建失败** - 容器创建过程中出错
3. **文件生成失败** - 代码生成过程中出错，但没有抛出异常
4. **前端显示问题** - 前端没有正确处理空文件树的情况

## 改进内容

### 前端改进 (CodeEditor.tsx)

1. **添加代码生成状态检测**
   - 根据应用状态 (`generating`, `deploying`, `requirements_confirmed`) 判断是否正在生成
   - 在生成过程中显示友好的提示信息

2. **自动轮询文件树**
   - 当检测到代码生成正在进行时，每 3 秒自动刷新文件树
   - 文件生成完成后自动停止轮询

3. **改进错误处理**
   - 在代码生成过程中，不显示错误信息（因为容器可能还在创建中）
   - 区分不同的错误情况，显示更友好的提示

4. **空状态处理**
   - 当文件树为空时，根据容器状态显示不同的提示
   - 区分"容器未创建"和"容器已创建但文件未生成"两种情况

### 诊断工具

创建了 `backend/test_container_status.py` 脚本来诊断问题：

```bash
cd backend
python test_container_status.py <application_id>
```

这个脚本会检查：
- 应用是否存在
- 应用状态
- 容器是否存在
- Docker 容器状态
- 文件树内容

## 使用方法

### 1. 检查容器状态

运行诊断脚本：

```bash
cd backend
python test_container_status.py <your_application_id>
```

### 2. 查看前端状态

前端现在会：
- 在代码生成中显示 "🔄 代码生成中，请稍候..."
- 自动每 3 秒刷新文件树
- 文件生成完成后自动显示

### 3. 手动刷新

如果自动刷新没有工作，可以点击文件树右上角的 🔄 按钮手动刷新。

## 常见问题排查

### 问题 1: 容器不存在

**症状**: 诊断脚本显示 "No container found"

**可能原因**:
- 代码生成还没有开始
- 容器创建失败

**解决方法**:
- 检查应用状态是否为 `requirements_confirmed`
- 查看后端日志中的错误信息
- 确认 Docker 服务正在运行

### 问题 2: 容器存在但文件树为空

**症状**: 容器存在，但 `/app` 目录为空

**可能原因**:
- 代码生成还在进行中
- 代码生成失败但没有抛出异常

**解决方法**:
- 等待几秒钟，前端会自动刷新
- 检查代码生成日志
- 查看容器内的进程状态

### 问题 3: Docker 容器不存在

**症状**: 数据库中有容器记录，但 Docker 容器不存在

**可能原因**:
- 容器被手动删除
- Docker 服务重启导致容器丢失

**解决方法**:
- 重新触发代码生成
- 检查 Docker 服务状态

## 日志检查

查看后端日志以获取更多信息：

```bash
# 查看代码生成相关日志
grep -i "code generation\|container\|file_tree" backend/logs/*.log

# 查看最近的错误
tail -100 backend/logs/*.log | grep -i error
```

## 下一步

如果问题仍然存在：

1. 运行诊断脚本获取详细信息
2. 检查后端日志
3. 确认 Docker 容器状态
4. 检查代码生成 agent 的执行日志

